<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- <link rel='stylesheet' href='css/style.css'> -->
    <title>FORM</title>
</head>
<body>
    <header>
        <h1>Pick what you want to do and when</h1>
        <h2 id="h2">Party Named </h2>
    </header>
    
    <br>
    <div class='nameInput'>
    <form name=>Your Name:
    <input type='text' id='leaderName'>
    </form>
    </div>
    
    <br>

    <p id="newdaytime" style="text-decoration: underline;">
        Add a New Window of Availability
    </p>
    <div id="daytime" style = "display: none;">
        <div class='dayInput'> 
            <label>Pick a Day: </label>
            <select id='day'> 
                <!-- <option value='1'>Friday</option>
                <option value='2'>Saturday</option>
                <option value='3'>Sunday</option> -->
            </select>
        </div>
        <br>
        
        <div class='timeOfDayInput'>
            <label> Pick a Time: </label>
            <select id='timeOfDay'>
                    <option value='1'>Morning</option>
                    <option value='2'>Afternoon</option>
                    <option value='3'>Night</option>
                    <option value='4'>After Hours</option>
            </select>
        </div>

        <button id="addavailablity">Add To Your Availability</button>
    </div>

    <div id="chosenDayTime">

    </div>

    
    
    <div class='activitysInput'>
        <label>And of course...Activity:  </label>
<!-- This select will be poplulated by server -->
        <select class='userActivity' id="userActivity" multiple size=9>
            <!-- <option value='1'>lets go eat somewhere</option>
            <option value='2'>catch a movie</option>
            <option value='3'>concert</option>
            <option value='4'>recreational sport</option>
            <option value='5'>sporting event</option>
            <option value='6'>museums</option>
            <option value='7'>beach</option>
            <option value='8'>clubbing</option>
            <option value='9'>bar-hopping</option>
            <option value='other'>Custom Idea</option> -->
        </select>
        <p>Use CTRL + Click to select multiple activities</p>
    </div>  
    
    
    <div class='otherChoiceInput'>
            <label>Users Own Choice 
                <input type='text' id='customActivity'>
            </label>
            <button id="btn-addChoice">Add to list</button>
    </div>
    
    <!-- ROUTES BUTTON TO THE ROOM PAGE -->
    <!-- <a class="routeToRoom" href="/room"> -->
        <button id='submitInfo'>ENTER!</button>
        <br/>
        <br/>
        <div id="afterSubmit"></div>
    <!-- </a> -->
    <br/>
    <button class="routeToRoom">BACK TO ROOM PAGE</button>    
    
    <script
      src="https://code.jquery.com/jquery-3.3.1.js"
      integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
      crossorigin="anonymous">
    </script>
    
    <script>

        //Get room name from URL
        var addr = $(location).attr('href').split("/");
        addr = addr[addr.length-2];
        var number_of_choices = 0;

        // var timeChoices = [];
        var timeChoices = {
            sunday: null,
            monday: null,
            tuesday: null,
            wednesday: null,
            thursday: null,
            friday: null,
            saturday: null
        }

        //Get activity options. Defaults AND custom activities for a certain room
        var categorychoices = [];

        $.ajax({
            method: "GET",
            url: "/api/form/" + addr
        }).then(results => {
            console.log(results);
            results.forEach((result, index)=>{
                number_of_choices++;
                var option = $("<option>");
                option.val(index);
                option.text(result.activity);
                $("#userActivity").append( option );
            })
            
        })

    
        console.log(addr);
        $("#h2").append(addr);

        //Possible days to have an activity
        // Drop down shows options for picking a day, up to a week ahead of time
        var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        var today = new Date().getDay();
        var ordereddays =[];
        // ordereddays[0] = days[today] + " (Today)";
        ordereddays[0] = days[today];
        for(var i=today; i<days.length ; i++){
            if(i !== today)
            ordereddays.push(days[i]);
        };
        for(var i=0 ; i<today ; i++){
            ordereddays.push(days[i]);
        }
    
        //ordereddays.push(days[today] + " (Next Week)");
    
        ordereddays.forEach(day =>{
            $("#day").append( $("<option>").text(day) );
        });

        $("#newdaytime").click(function(){
            $("#daytime").toggle();
        });

        $("#addavailablity").click(function(){
            addAvailability();
        });

        $("#chosenDayTime").on("click", ".deleteEntry", function(){
            console.log("inside delete entry");
            var dayToDelete = $(this).parent().find(":contains('Day')").text().split(" ")[1].toLowerCase();
            console.log( dayToDelete );
            timeChoices[dayToDelete] = null;
            // console.log( $(this).parent().find(":contains('Day')").text() );
            $(this).closest("span").remove();
        })
        

        //Add a custom activity to list and select it
        $("#btn-addChoice").click(function(){
            var option = $("<option>");
            option.val(number_of_choices);
            option.text( $("#customActivity").val() );
            option.attr("selected", true);
            $("#userActivity").append( option );
            $("#customActivity").val("");
        });


        function addAvailability(){
            var day = $("#day").val();
            var time = $("#timeOfDay :selected").text();
            if(timeChoices[day.toLowerCase()] === null ){
                timeChoices[day.toLowerCase()] = time;

                var newEntry = $("<span>");
                newEntry.addClass(day);
                newEntry.append( $("<p>").text("Day: " + day) );
                newEntry.append( $("<p>").text("Time: " + time) );
                newEntry.append( $("<button>").text("Delete").attr("class", "deleteEntry") );
                $("#chosenDayTime").append(newEntry);
            }

            
        }
        
        //Send info to server
        // user click to grab all the data
        $("#submitInfo").on("click",function(){

            // name, day, time of day value
            var name=$("#leaderName").val();
            var day=$("#day").val();
            //var timeOfDay=$("#timeOfDay").val();
            // var activity=$("#userActivity").val();
            // var customActivity=null;


            var chosen_categories = [];

            var t = $("#userActivity :selected").each(function(){
                chosen_categories.push($(this).text())
            });
  
            //object to send to back-end
            // var infoForBack={
            //     person:name,
            //     day:day,
            //     time:timeOfDay,
            //     activity:chosen_categories,
            //     custom:customActivity

            // }

            var infoForBack={
                person:name,
                times: timeChoices,
                activity:chosen_categories,
                custom:customActivity

            }
            console.log(infoForBack)
    
            // $.post('/'+addr+"/form",infoForBack).then(function(){
            //     console.log('sent!')
            //     $("#afterSubmit").append("YOUR INFO HAS BEEN SUBMITTED! YOU MAY NOW GO BACK TO YOUR ROOM PAGE")
            // })

            $(".routeToRoom").on('click', ()=> {
                $(location).attr('href', '/' + addr)
            }) 
            
        });
            
    </script>
        
    </body>
</html>
